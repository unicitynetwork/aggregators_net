services:
  alphabill:
    platform: linux/amd64
    image: ghcr.io/alphabill-org/alphabill:e66b1068dcc7a94db107c2d1430b1b09a28b75ee

  initialize-root-node:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill root-node init --home "/genesis" -g'

  generate-root-trust-base:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill trust-base generate --home "/genesis" --network-id 3 --node-info /genesis/root/node-info.json'

  sign-root-trust-base:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill trust-base sign --home "/genesis/root" --trust-base /genesis/trust-base.json'

  run-root-node:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill root-node run --home "/genesis/root" --address "/ip4/$(hostname -i)/tcp/8000" --trust-base /genesis/trust-base.json --rpc-server-address "$(hostname -i):8002"'
    volumes:
      - ./genesis:/genesis
    expose:
      - 8000

  initialize-shard-node:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill shard-node init --home "/genesis/tokens" --generate'

  generate-shard-conf:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill shard-conf generate --home "/genesis" --network-id 3 --partition-id 2 --partition-type-id 2 --epoch-start 10 --node-info=/genesis/tokens/node-info.json'

  upload-shard-conf:
    image: curlimages/curl
    command: >-
      curl -X PUT
      -H 'Content-Type: application/json'
      -d '@/genesis/shard-conf-2_0.json'
      'http://alphabill-root:8002/api/v1/configurations'

  generate-shard-genesis:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill shard-conf genesis --home "/genesis/tokens" --shard-conf /genesis/shard-conf-2_0.json'

  run-shard-node:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill shard-node run --home "/genesis/tokens" --trust-base /genesis/trust-base.json --shard-conf /genesis/shard-conf-2_0.json --address "/ip4/$(hostname -i)/tcp/8001" --bootnodes "/dns/alphabill-root/tcp/8000/p2p/$(alphabill node-id --home /genesis/root | tail -n1)" --rpc-server-address "$(hostname -i):8003"'
    expose:
      - 8001
