services:
  alphabill:
    platform: linux/amd64
    image: ghcr.io/alphabill-org/alphabill:e66b1068dcc7a94db107c2d1430b1b09a28b75ee

  initialize-root-node:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill root-node init --home "/genesis" -g'

  generate-root-trust-base:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill trust-base generate --home "/genesis" --network-id 3 --node-info /genesis/root1/node-info.json --node-info /genesis/root2/node-info.json --node-info /genesis/root3/node-info.json'

  sign-root-trust-base:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill trust-base sign --home "/genesis/root" --trust-base /genesis/trust-base.json'

  run-root-node:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill root-node run --home "/genesis/root" --address "/ip4/$(hostname -i)/tcp/8000" --trust-base /genesis/trust-base.json --rpc-server-address "$(hostname -i):8002"'
    volumes:
      - ./genesis:/genesis
    expose:
      - 8000

  run-root-node23:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill root-node run --home "/genesis/root" --address "/ip4/$(hostname -i)/tcp/8000" --bootnodes=/dns/alphabill-root1/tcp/8000/p2p/$(alphabill node-id --home "/genesis/root1" | tail -n1) --trust-base /genesis/trust-base.json --rpc-server-address "$(hostname -i):8002"'
    volumes:
      - ./genesis:/genesis
    expose:
      - 8000

  initialize-shard-node:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill shard-node init --home "/genesis/tokens" --generate'

  generate-shard-conf:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill shard-conf generate --home "/genesis" --network-id 3 --partition-id 2 --partition-type-id 2 --epoch-start 10 --node-info=/genesis/tokens/node-info.json'

  upload-shard-conf:
    extends:
      service: alphabill
    image: curlimages/curl
    command:
      - 'curl -X PUT -H "Content-Type: application/json" "http://localhost:8000/api/v1/configurations"'

  generate-shard-genesis:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill shard-conf genesis --home "/genesis/tokens" --shard-conf /genesis/shard-conf-2_0.json'

  run-shard-node:
    extends:
      service: alphabill
    entrypoint:
      - /busybox/sh
      - -c
      - 'alphabill shard-node run --home "/genesis/tokens" --trust-base /genesis/trust-base.json --shard-conf /genesis/shard-conf-2_0.json --address "/ip4/$(hostname -i)/tcp/8001" --bootnodes "/dns/alphabill-root1/tcp/8000/p2p/$(alphabill node-id --home /genesis/root1 | tail -n1)" --rpc-server-address "localhost:8003"'
    expose:
      - 8000
